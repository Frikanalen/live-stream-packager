apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "live-stream-packager.fullname" . }}
  labels:
    {{- include "live-stream-packager.labels" . | nindent 4 }}
    app.kubernetes.io/component: packager
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "live-stream-packager.selectorLabels" . | nindent 6 }}
  minReadySeconds: 5
  template:
    metadata:
      labels:
        {{- include "live-stream-packager.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: packager
    spec:
      volumes:
        - name: shared-data
          emptyDir: {}
        - name: nginx-config
          configMap:
            name: {{ include "live-stream-packager.fullname" . }}-nginx

      containers:
        # ffmpeg transcoder
        - name: ffmpeg-transcoder
          image: "{{ .Values.image.ffmpeg.repository }}:{{ .Values.image.ffmpeg.tag }}"
          imagePullPolicy: {{ .Values.image.ffmpeg.pullPolicy }}
          command: ["/bin/sh", "-c", "sleep 15s; echo \"DEBUG ENCODING: $ENCODING_OPTIONS\" >&2; ffmpeg -progress pipe:2 -stats $FFMPEG_OPTIONS -i $SOURCE_URL $(echo $ENCODING_OPTIONS | tr '\\n' ' ')"]
          volumeMounts:
            - name: shared-data
              mountPath: /stream
          env:
            - name: ENCODING_OPTIONS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "live-stream-packager.fullname" . }}-ffmpeg
                  key: encodingOptions
            - name: SOURCE_URL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "live-stream-packager.fullname" . }}-ffmpeg
                  key: inputSourceUrl
            - name: FFMPEG_OPTIONS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "live-stream-packager.fullname" . }}-ffmpeg
                  key: ffmpegOptions
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "pgrep -x ffmpeg > /dev/null"
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 3
          resources:
            {{- with .Values.resources.ffmpeg }}
            {{- toYaml . | nindent 12 }}
            {{- end }}

        # Shaka packager
        - name: shaka-packager
          image: "{{ .Values.image.packager.repository }}:{{ .Values.image.packager.tag }}"
          imagePullPolicy: {{ .Values.image.packager.pullPolicy }}
          command: ["/bin/sh", "-c", "packager $ARGUMENTS"]
          workingDir: /stream
          env:
            - name: ARGUMENTS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "live-stream-packager.fullname" . }}-shaka
                  key: packagerArguments
            # shaka-packager depends on being able to link between tmp and output directories
            # so this is how we hack it all together
            - name: TMPDIR
              value: /stream
          volumeMounts:
            - name: shared-data
              mountPath: /stream
          startupProbe:
            exec:
              command: ["/bin/sh", "-c", "pgrep -x packager && test -f {{ .Values.health.playlistPath }}"]
            initialDelaySeconds: 20
            periodSeconds: 5
            failureThreshold: {{ .Values.health.startupFailureThreshold }}
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  pgrep -x packager > /dev/null || exit 1
                  [ -f {{ .Values.health.playlistPath }} ] && [ $(($(date +%s) - $(stat -c %Y {{ .Values.health.playlistPath }}))) -lt {{ .Values.health.maxAgeSeconds }} ]
            periodSeconds: 10
            failureThreshold: 3
          readinessProbe:
            exec:
              command: ["/bin/sh", "-c", "test -f {{ .Values.health.playlistPath }}"]
            periodSeconds: 5
            failureThreshold: 3
          resources:
            {{- with .Values.resources.packager }}
            {{- toYaml . | nindent 12 }}
            {{- end }}

        # Nginx web server
        - name: nginx-web
          image: "{{ .Values.image.nginx.repository }}:{{ .Values.image.nginx.tag }}"
          imagePullPolicy: {{ .Values.image.nginx.pullPolicy }}
          volumeMounts:
            - name: shared-data
              mountPath: /usr/share/nginx/html
            - name: nginx-config
              mountPath: /etc/nginx/conf.d
          ports:
            - name: http
              containerPort: 80

          livenessProbe:
            tcpSocket:
              port: 80
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /index.m3u8
              port: 80
            initialDelaySeconds: 25
            periodSeconds: 5
            failureThreshold: 3
          resources:
            {{- with .Values.resources.nginx }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
