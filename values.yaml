nameOverride: ""
fullnameOverride: ""

image:
  ffmpeg:
    repository: jrottenberg/ffmpeg
    tag: 8-alpine
    pullPolicy: IfNotPresent

  packager:
    repository: google/shaka-packager
    tag: v3.4.2
    pullPolicy: IfNotPresent

  nginx:
    repository: nginx
    tag: latest
    pullPolicy: IfNotPresent

  cubemap:
    repository: ghcr.io/frikanalen/cubemap
    tag: latest
    pullPolicy: IfNotPresent

# ffmpeg / input pipeline configuration
ffmpeg:
  ffmpegOptions: "-probesize 100M -threads 10 -strict -2"
  # When cubemap.enabled, this is overridden to read from Cubemap HTTP
  inputSourceUrl: "http://192.168.3.1:9094/frikanalen.ts"
  encodingOptions: |
    -pix_fmt yuv420p -filter_complex [0:v]split=2[s1][s2]

    -map 0:1 -codec:a libfdk_aac -f mpegts udp://127.0.0.1:9000

    -map [s1] -b:v 1000k -maxrate:v 1500k -bufsize:v 2000k
      -profile:v baseline -preset fast -tune zerolatency
      -g 100 -sc_threshold 0 -codec:v libx264
      -f mpegts udp://127.0.0.1:9002

    -map [s2] -b:v 4000k -maxrate:v 5000k -bufsize:v 8000k
      -preset fast -tune zerolatency
      -g 100 -sc_threshold 0 -codec:v libx264
      -f mpegts udp://127.0.0.1:9003

# Shaka packager configuration
shaka:
  packagerArguments: |
    in=udp://0.0.0.0:9000?buffer_size=212992,stream=audio,init_segment=livehd-audio.mp4,segment_template=livehd-audio-$Number$.mp4
    in=udp://0.0.0.0:9002?buffer_size=212992,stream=video,bw=1400000,init_segment=livehd-video2.mp4,template=livehd-video2-$Number$.mp4
    in=udp://0.0.0.0:9003?buffer_size=212992,stream=video,bw=3000000,init_segment=livehd-video3.mp4,template=livehd-video3-$Number$.mp4
    --mpd_output index.mpd --dump_stream_info --min_buffer_time=12
    --hls_playlist_type LIVE --hls_master_playlist_output index.m3u8
    --time_shift_buffer_depth=300 --segment_duration=2 --io_block_size 65536

replicaCount: 1

resources: {}
#  ffmpeg:
#    limits:
#      cpu: "2"
#      memory: "2Gi"
#    requests:
#      cpu: "1"
#      memory: "1Gi"
#  packager: {}
#  nginx: {}

nodeSelector: {}
tolerations: []
affinity: {}

# Health checks for shaka-packager
health:
  playlistPath: "/stream/index.m3u8"
  maxAgeSeconds: 60
  startupFailureThreshold: 60  # 60 * 5s = 5 min max startup time

service:
  type: ClusterIP
  port: 80

# Cubemap UDP reflector - receives UDP and serves HTTP for graceful rollouts
cubemap:
  enabled: true
  udpPort: 5004
  httpPort: 9094
  loadBalancerIP: "192.168.3.91"
  backlogSize: 10485760  # 10MB backlog

ingress:
  enabled: true
  host: "staging.frikanalen.no"
  pathPrefix: "/stream/"
  entryPoints:
    - websecure
  tls:
    enabled: true
    certResolver: "letsencrypt"

